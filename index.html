<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ID Photo 4×6 Layout • 35×45 mm (Bordered-Calibrated)</title>
<style>
:root{
  --bg:#0b0c10;--panel:#14161b;--muted:#9095a0;--text:#e9edf1;
  --acc:#6ee7b7;--acc2:#8ab4f8;--border:#252a33;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
.wrap{max-width:1100px;margin:24px auto;padding:0 16px}
header{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
header h1{font-size:20px;margin:0}
.badge,.pill,.version{padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
.badge{background:#1f2937;color:#cbd5e1}
.pill{background:#1a222c;color:#cbd5e1}
.version{background:#272a32;color:#a5b4fc;border-color:#383d47}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
.controls{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;align-items:end}
.field{display:flex;flex-direction:column;gap:6px;grid-column:span 3}
.field.wide{grid-column:span 6}
label{font-size:12px;color:var(--muted)}
select,button,input[type="checkbox"]{
  appearance:none;border:1px solid var(--border);background:#0f1116;color:#e9edf1;
  border-radius:10px;padding:10px 12px;font-size:14px
}
input[type="checkbox"]{width:auto;transform:scale(1.15);margin-right:8px;vertical-align:middle}
button.primary{background:linear-gradient(135deg,var(--acc2),var(--acc));color:#0b0c10;border:none;font-weight:600}
.row{display:flex;gap:10px;flex-wrap:wrap}
.drop{border:2px dashed #2b323d;border-radius:12px;padding:18px;text-align:center;color:#cbd5e1;
  cursor:pointer;background:#0f1116;transition:border-color .2s}
.drop.drag{border-color:var(--acc);background:#0e161f}
.preview{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
canvas{width:100%;height:auto;background:#fff;border-radius:12px;border:1px solid var(--border)}
.note{color:#aab1bc;font-size:12px}
footer{margin:24px 0;color:#9aa3af;font-size:12px;text-align:center}
#file{display:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ID Photo 4×6 Layout</h1>
    <span class="badge">35×45 mm • 3×2 grid • Bordered +3%</span>
    <span class="pill">600 DPI • Works offline</span>
    <span class="version" id="versionTag"></span>
  </header>

  <section class="panel">
    <div class="controls">
      <div class="field wide">
        <label>Upload or drag & drop</label>
        <label id="drop" class="drop">Drop image here or click to choose
          <input id="file" type="file" accept="image/*" />
        </label>
        <div class="note">Print with **Paper 4×6 in**, **Bordered ON**, **Scale 100% (Actual size)** → final photos are true 35×45 mm.</div>
      </div>

      <!-- Cut line controls -->
      <div class="field">
        <label>Cut line color</label>
        <select id="lineColor">
          <option value="#444444" selected>Dark gray (60%)</option>
          <option value="#000000">Black</option>
          <option value="#777777">Lighter gray</option>
          <option value="#ff0000">Red</option>
        </select>
      </div>
      <div class="field">
        <label>Cut line width</label>
        <select id="lineWidth">
          <option value="2" selected>2 px</option>
          <option value="1">1 px</option>
          <option value="3">3 px</option>
        </select>
      </div>
      <div class="field">
        <label>Dash length</label>
        <select id="dashLen">
          <option value="10" selected>10</option>
          <option value="8">8</option>
          <option value="12">12</option>
        </select>
      </div>
      <div class="field">
        <label>Dash gap</label>
        <select id="dashGap">
          <option value="6" selected>6</option>
          <option value="5">5</option>
          <option value="8">8</option>
        </select>
      </div>

      <div class="field wide" style="display:flex;align-items:center;gap:10px">
        <input type="checkbox" id="showFrame" />
        <label for="showFrame">Show thin white frame inside each photo</label>
      </div>

      <div class="field wide">
        <div class="row">
          <button id="render" class="primary">Render 4×6 Sheet</button>
          <button id="downloadJpg">Download JPEG</button>
          <button id="printBtn">Print</button>
          <button id="resetBtn">Reset</button>
        </div>
      </div>
    </div>

    <div class="preview">
      <!-- 6×4 in @ 600 DPI -->
      <canvas id="canvas" width="3600" height="2400"></canvas>
      <div class="panel" style="background:#0f1116">
        <h3 style="margin:0 0 8px 0;font-size:14px;color:#cbd5e1">Notes</h3>
        <ul style="margin:0;padding-left:18px;line-height:1.6;color:#cbd5e1">
          <li>Grid is scaled +3% *as a whole* to compensate Selphy’s bordered shrink.</li>
          <li>Dashed cut lines drawn on every photo edge (6 vertical, 3 horizontals + top/bottom).</li>
          <li>Use “Download JPEG” when sending to phone apps.</li>
        </ul>
      </div>
    </div>
  </section>

  <footer>Print settings → Paper 4×6 in • <b>Bordered ON</b> • <b>Scale 100%</b> (Actual size). Borderless will break millimetre accuracy.</footer>
</div>

<script>
(function(){
  // Version badge
  const now=new Date();
  document.getElementById("versionTag").textContent =
    `v${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,"0")}.${String(now.getDate()).padStart(2,"0")}`;

  // Elements
  const fileInput=document.getElementById("file");
  const drop=document.getElementById("drop");
  const canvas=document.getElementById("canvas");
  const ctx=canvas.getContext("2d");
  const renderBtn=document.getElementById("render");
  const downloadBtn=document.getElementById("downloadJpg");
  const printBtn=document.getElementById("printBtn");
  const resetBtn=document.getElementById("resetBtn");
  const showFrame=document.getElementById("showFrame");

  const lineColorSel=document.getElementById("lineColor");
  const lineWidthSel=document.getElementById("lineWidth");
  const dashLenSel=document.getElementById("dashLen");
  const dashGapSel=document.getElementById("dashGap");

  // Constants
  const DPI=600;
  const mmToIn = mm => mm/25.4;
  const inToPx = inch => Math.round(inch*DPI);

  // Target cell (true size) and layout
  const CELL_MM = { w:35, h:45 };
  const GRID = { cols:3, rows:2 };
  const PAGE_PX = { W: inToPx(6), H: inToPx(4) }; // 3600×2400

  // Global scale to compensate *bordered* shrink on Selphy
  const GLOBAL_SCALE = 1.03; // +3%

  let loadedImg = null;

  // Compute base layout (exact sizes), then scale entire grid about page center
  function computeLayout(){
    const W=PAGE_PX.W, H=PAGE_PX.H;
    const pw = Math.round(mmToIn(CELL_MM.w)*DPI);
    const ph = Math.round(mmToIn(CELL_MM.h)*DPI);

    // Even margins: (W - cols*pw) / (cols+1)
    const usedW = GRID.cols*pw;
    const usedH = GRID.rows*ph;
    const gapX = (W - usedW)/(GRID.cols+1);
    const gapY = (H - usedH)/(GRID.rows+1);

    // Base positions (unscaled)
    const base = [];
    for(let r=0;r<GRID.rows;r++){
      for(let c=0;c<GRID.cols;c++){
        const x = gapX*(c+1) + pw*c;
        const y = gapY*(r+1) + ph*r;
        base.push({x,y,w:pw,h:ph});
      }
    }

    // Scale entire grid about page center
    const cx = W/2, cy = H/2;
    const scaled = base.map(b=>{
      const bx = b.x + b.w/2, by = b.y + b.h/2; // rect center
      const nx = cx + (bx - cx)*GLOBAL_SCALE;
      const ny = cy + (by - cy)*GLOBAL_SCALE;
      const nw = b.w*GLOBAL_SCALE, nh = b.h*GLOBAL_SCALE;
      return { x: Math.round(nx - nw/2), y: Math.round(ny - nh/2), w: Math.round(nw), h: Math.round(nh) };
    });

    return { W,H, cells: scaled };
  }

  function drawImageInCell(img, cell){
    const {x,y,w,h} = cell;
    const iw=img.naturalWidth, ih=img.naturalHeight;
    const ir=iw/ih, cr=w/h;
    let dw=w, dh=h, dx=x, dy=y;
    // Cover (fill cell, crop if needed)
    if(ir>cr){ dh=h; dw=h*ir; dx=x+(w-dw)/2; }
    else     { dw=w; dh=w/ir; dy=y+(h-dh)/2; }
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  // Build full dashed grid from cell edges
  function drawDashedCuts(layout){
    const {W,H,cells} = layout;

    // Collect unique vertical and horizontal edges
    const vSet = new Set();
    const hSet = new Set();
    for(const c of cells){
      vSet.add(c.x); vSet.add(c.x + c.w);
      hSet.add(c.y); hSet.add(c.y + c.h);
    }
    const V = Array.from(vSet).sort((a,b)=>a-b);
    const Hs= Array.from(hSet).sort((a,b)=>a-b);

    // Margins for line ends (keep a little white outside)
    const leftPad = Math.max(8, Math.min(...V));
    const rightPad = Math.max(8, W - Math.max(...V));
    const topPad = Math.max(8, Math.min(...Hs));
    const bottomPad = Math.max(8, H - Math.max(...Hs));

    ctx.save();
    ctx.strokeStyle = lineColorSel.value;
    ctx.lineWidth   = parseInt(lineWidthSel.value,10);
    ctx.setLineDash([parseInt(dashLenSel.value,10), parseInt(dashGapSel.value,10)]);

    // Vertical lines (full height inside outer pads)
    for(const x of V){
      ctx.beginPath();
      ctx.moveTo(x, topPad);
      ctx.lineTo(x, H - bottomPad);
      ctx.stroke();
    }
    // Horizontal lines (full width inside outer pads)
    for(const y of Hs){
      ctx.beginPath();
      ctx.moveTo(leftPad, y);
      ctx.lineTo(W - rightPad, y);
      ctx.stroke();
    }
    ctx.restore();
  }

  function render(){
    if(!loadedImg){ alert("Please upload an image first."); return; }

    const layout = computeLayout();
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,layout.W,layout.H);

    // Draw images
    for(const c of layout.cells){
      drawImageInCell(loadedImg, c);
      if(showFrame.checked){
        ctx.save();
        ctx.strokeStyle="#ffffff";
        ctx.lineWidth=1.5;
        ctx.strokeRect(c.x+0.5, c.y+0.5, c.w-1, c.h-1);
        ctx.restore();
      }
    }
    // Draw dashed cut lines (all edges)
    drawDashedCuts(layout);
  }

  function downloadJPEG(){
    const a=document.createElement("a");
    a.href=canvas.toDataURL("image/jpeg",0.95);
    a.download="ID-4x6-bordered-calibrated.jpg";
    a.click();
  }

  function openPrint(){
    const imgURL=canvas.toDataURL("image/png");
    const w=window.open("","_blank");
    const html=`<!DOCTYPE html><html><head><meta charset='utf-8'>
    <style>@page{size:6in 4in;margin:0}body{margin:0;display:flex;justify-content:center;align-items:center;background:#fff}
    img{width:6in;height:4in;}</style></head>
    <body><img src='${imgURL}' alt='layout'>
    <script>window.onload=()=>{alert("Print with Paper 4×6 in • Bordered ON • Scale 100% (Actual size)");window.print()}<\/script>
    </body></html>`;
    w.document.write(html); w.document.close();
  }

  function reset(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#fff";ctx.fillRect(0,0,canvas.width,canvas.height);
    loadedImg=null;
    const ni=fileInput.cloneNode(true);
    fileInput.parentNode.replaceChild(ni,fileInput);
    ni.addEventListener("change",e=>{ const f=e.target.files?.[0]; if(f)load(f); });
    drop.textContent="Drop image here or click to choose";
    showFrame.checked=false;
  }

  // File handling
  function load(f){
    if(!f.type.startsWith("image/")){ alert("Please choose an image file."); return; }
    const url=URL.createObjectURL(f);
    const img=new Image();
    img.onload=()=>{ loadedImg=img; URL.revokeObjectURL(url); drop.textContent=f.name+" ✓ (click to change)"; render(); };
    img.src=url;
  }

  // Drag & drop
  drop.addEventListener("dragover",e=>{e.preventDefault();drop.classList.add("drag")});
  drop.addEventListener("dragleave",()=>drop.classList.remove("drag"));
  drop.addEventListener("drop",e=>{
    e.preventDefault(); drop.classList.remove("drag");
    const f=e.dataTransfer.files?.[0]; if(f)load(f);
  });
  fileInput.addEventListener("change",e=>{ const f=e.target.files?.[0]; if(f)load(f); });

  // Re-render on control changes
  [lineColorSel,lineWidthSel,dashLenSel,dashGapSel,showFrame].forEach(el=>{
    el.addEventListener("change",()=>{ if(loadedImg) render(); });
  });

  // Buttons
  renderBtn.onclick=render;
  downloadBtn.onclick=downloadJPEG;
  printBtn.onclick=openPrint;
  resetBtn.onclick=reset;

  // Initial white page
  ctx.fillStyle="#fff";ctx.fillRect(0,0,canvas.width,canvas.height);
})();
</script>
</body>
</html>
